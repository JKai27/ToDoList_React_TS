image: harbor.marcapo.com/marcapo/node-build-image:16

stages:
  - verify
  - deploy

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\\n\\tStrictHostKeyChecking no\\n\\n" > ~/.ssh/config'
  - git config --global user.email "gitlab-ci@marcapo.com"
  - git config --global user.name "GitlabCI"

verify:
  stage: verify
  script:
    - node -v
    - npm -v
    - rm -rf node_modules && rm -rf package-lock.json && npm set registry http://sinopia.marcapo.ebern:4873 && npm install --force || npm run update
    - npm run lint
    - npm run build
  except:
    - master
    - patch
    - tags
  tags:
    - general
deploy:
  stage: deploy
  retry: 1
  script:
    - rm -rf node_modules && rm -rf package-lock.json && npm set registry http://sinopia.marcapo.ebern:4873 && npm install --force || npm run update
    - npm run lint
    - 'TOKEN=$(curl -s -H "Accept: application/json" -H "Content-Type:application/json" -X PUT --data "{\"name\":\"marcapo\",\"password\":\"$NPM_PW\"}" --user marcapo:$NPM_PW http://sinopia.marcapo.ebern:4873/-/user/org.couchdb.user:marcapo)'
    - TOKEN=$(echo $TOKEN | jq -r '.token')
    - 'npm set registry http://sinopia.marcapo.ebern:4873 && echo -e "registry=http://sinopia.marcapo.ebern:4873\n//sinopia.marcapo.ebern:4873/:_authToken="$TOKEN"" > ~/.npmrc'
    - npm run build
    - npm run copyCss || echo "no css folder to be copied"
    - git checkout -- package.json
    - git rm --cached .prettierrc tslint.js .eslintrc.json .eslintignore || echo "no such files"
    - git add package-lock.json && git commit -m 'updated package-lock.json [ci skip]' || echo "nothing to commit"
    - npm version patch -m 'new version %s [ci skip]' && git push git@git.marcapo.com:marcapo/antd-components.git HEAD:master && npm publish
  only:
    - master
  except:
    - tags
  tags:
    - general
