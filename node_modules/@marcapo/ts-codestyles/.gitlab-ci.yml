image: harbor.marcapo.com/it/jenkins-slave-docker-image:14.16

stages:
  - deploy

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\\n\\tStrictHostKeyChecking no\\n\\n" > ~/.ssh/config'
  - git config --global user.email "gitlab-ci@marcapo.com"
  - git config --global user.name "GitlabCI"

deploy:
  stage: deploy
  retry: 0
  script:
    - rm -rf node_modules && rm -rf package-lock.json && npm set registry http://sinopia.marcapo.ebern:4873 && npm install
    - 'TOKEN=$(curl -s -H "Accept: application/json" -H "Content-Type:application/json" -X PUT --data "{\"name\":\"marcapo\",\"password\":\"$NPM_PW\"}" --user marcapo:$NPM_PW http://sinopia.marcapo.ebern:4873/-/user/org.couchdb.user:marcapo)'
    - TOKEN=$(echo $TOKEN | jq -r '.token')
    - 'npm set registry http://sinopia.marcapo.ebern:4873 && echo -e "registry=http://sinopia.marcapo.ebern:4873\n//sinopia.marcapo.ebern:4873/:_authToken="$TOKEN"" > ~/.npmrc'
    - npm run build
    - git add -f package-lock.json || echo '#'
    - git commit -a -m'version update [ci skip]' || echo '#'
    - npm version patch -m "new version %s [ci skip]"
    - git push git@git.marcapo.com:marcapo/ts-codestyles.git HEAD:master
    - npm publish
  only:
    - master
  except:
    - tags
  tags:
    - general